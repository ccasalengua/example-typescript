import { Board } from "./board.js";
import { Snake } from "./snake.js";
export class Game {
    constructor() {
        const canvas = document.getElementById('game');
        this.board = new Board(canvas);
        this.snake = new Snake({ positionX: 160, positionY: 160 }, { vectorX: Game.grid, vectorY: 0 }, 10);
        this.frameCount = 0;
        this.gameOver = false;
        this.pause = false;
        this.registerActions();
    }
    registerActions() {
        let lastKey = 39; // right arrow key default
        document.addEventListener('keydown', (e) => {
            // prevent snake from backtracking on itself by checking that it's 
            // not already moving on the same axis (pressing left while moving
            // left won't do anything, and pressing right while moving left
            // shouldn't let you collide with your own body)
            console.log(e.which, this.pause);
            const snakeDirection = this.snake.getDirection();
            if (!this.pause) {
                if (e.which === 37 && snakeDirection.vectorX === 0) { // left arrow key
                    this.snake.changeDirection({ vectorX: -Game.grid, vectorY: 0 });
                    lastKey = 37;
                }
                else if (e.which === 38 && snakeDirection.vectorY === 0) { // up arrow key
                    this.snake.changeDirection({ vectorX: 0, vectorY: -Game.grid });
                    lastKey = 38;
                }
                else if (e.which === 39 && snakeDirection.vectorX === 0) { // right arrow key
                    this.snake.changeDirection({ vectorX: Game.grid, vectorY: 0 });
                    lastKey = 39;
                }
                else if (e.which === 40 && snakeDirection.vectorY === 0) { // down arrow key
                    this.snake.changeDirection({ vectorX: 0, vectorY: Game.grid });
                    lastKey = 40;
                }
                else if ((e.which === 80 || e.which === 13)) { //Pause
                    console.log('entra pause');
                    this.snake.changeDirection({ vectorX: 0, vectorY: 0 });
                    this.pause = true;
                }
            }
            else {
                if ((e.which === 80 || e.which === 13)) {
                    console.log('entra en NO pause');
                    this.pause = false;
                    this.start();
                    if (lastKey === 37 && snakeDirection.vectorX === 0) { // left arrow key
                        this.snake.changeDirection({ vectorX: -Game.grid, vectorY: 0 });
                    }
                    else if (lastKey === 38 && snakeDirection.vectorY === 0) { // up arrow key
                        this.snake.changeDirection({ vectorX: 0, vectorY: -Game.grid });
                    }
                    else if (lastKey === 39 && snakeDirection.vectorX === 0) { // right arrow key
                        this.snake.changeDirection({ vectorX: Game.grid, vectorY: 0 });
                    }
                    else if (lastKey === 40 && snakeDirection.vectorY === 0) { // down arrow key
                        this.snake.changeDirection({ vectorX: 0, vectorY: Game.grid });
                    }
                }
            }
        });
    }
    isSnakeCollision() {
        const snakeCells = this.snake.getCells();
        return snakeCells.some((c, i) => {
            return i > 0 && c.positionX === snakeCells[0].positionX && c.positionY === snakeCells[0].positionY;
        });
    }
    start() {
        if (!this.gameOver || !this.pause) {
            requestAnimationFrame(this.start.bind(this));
            if (++this.frameCount < 10)
                return;
            this.frameCount = 0;
            this.snake.move(this.board.getHeight(), this.board.getWidth(), Game.grid);
            this.board.draw(this.snake, Game.grid);
            this.gameOver = this.isSnakeCollision();
        }
        else if (this.pause) {
            this.board.pause();
        }
        else {
            this.board.gameOver();
        }
    }
}
Game.grid = 16;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdhbWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNuQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBR25DLE1BQU0sT0FBTyxJQUFJO0lBU2I7UUFDSSxNQUFNLE1BQU0sR0FBeUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNyRixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQy9CLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNuRyxJQUFJLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQztRQUNwQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVPLGVBQWU7UUFDbkIsSUFBSSxPQUFPLEdBQVcsRUFBRSxDQUFDLENBQUksMEJBQTBCO1FBQ3ZELFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFnQixFQUFFLEVBQUU7WUFDdEQsbUVBQW1FO1lBQ25FLGtFQUFrRTtZQUNsRSwrREFBK0Q7WUFDL0QsZ0RBQWdEO1lBQ2hELE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDaEMsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FB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R0FBRyxDQUFDLENBQUM7WUFDcEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMxRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN2QyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1NBQzNDO2FBQU0sSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ25CLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDdEI7YUFBSztZQUNGLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDekI7SUFFTCxDQUFDOztBQW5GYyxTQUFJLEdBQVcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IEJvYXJkIH0gZnJvbSBcIi4vYm9hcmQuanNcIjtcclxuaW1wb3J0IHsgU25ha2UgfSBmcm9tIFwiLi9zbmFrZS5qc1wiO1xyXG5pbXBvcnQgeyBQb2ludCB9IGZyb20gXCIuL21vZGVscy9tb2RlbHMuanNcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBHYW1lIHtcclxuXHJcbiAgICBwcml2YXRlIGJvYXJkOiBCb2FyZDtcclxuICAgIHByaXZhdGUgc25ha2U6IFNuYWtlO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ3JpZDogbnVtYmVyID0gMTY7XHJcbiAgICBwcml2YXRlIGZyYW1lQ291bnQ6IG51bWJlcjtcclxuICAgIHByaXZhdGUgZ2FtZU92ZXI6IGJvb2xlYW47XHJcbiAgICBwcml2YXRlIHBhdXNlOiBib29sZWFuO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkgeyBcclxuICAgICAgICBjb25zdCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gPEhUTUxDYW52YXNFbGVtZW50PmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdnYW1lJyk7XHJcbiAgICAgICAgdGhpcy5ib2FyZCA9IG5ldyBCb2FyZChjYW52YXMpO1xyXG4gICAgICAgIHRoaXMuc25ha2UgPSBuZXcgU25ha2UoeyBwb3NpdGlvblg6IDE2MCwgcG9zaXRpb25ZOiAxNjAgfSwgeyB2ZWN0b3JYOiBHYW1lLmdyaWQsIHZlY3Rvclk6IDAgfSwgMTApO1xyXG4gICAgICAgIHRoaXMuZnJhbWVDb3VudCA9IDA7XHJcbiAgICAgICAgdGhpcy5nYW1lT3ZlciA9IGZhbHNlO1xyXG4gICAgICAgIHRoaXMucGF1c2UgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnJlZ2lzdGVyQWN0aW9ucygpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJBY3Rpb25zKCk6IHZvaWQge1xyXG4gICAgICAgIGxldCBsYXN0S2V5OiBudW1iZXIgPSAzOTsgICAgLy8gcmlnaHQgYXJyb3cga2V5IGRlZmF1bHRcclxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGU6IEtleWJvYXJkRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgLy8gcHJldmVudCBzbmFrZSBmcm9tIGJhY2t0cmFja2luZyBvbiBpdHNlbGYgYnkgY2hlY2tpbmcgdGhhdCBpdCdzIFxyXG4gICAgICAgICAgICAvLyBub3QgYWxyZWFkeSBtb3Zpbmcgb24gdGhlIHNhbWUgYXhpcyAocHJlc3NpbmcgbGVmdCB3aGlsZSBtb3ZpbmdcclxuICAgICAgICAgICAgLy8gbGVmdCB3b24ndCBkbyBhbnl0aGluZywgYW5kIHByZXNzaW5nIHJpZ2h0IHdoaWxlIG1vdmluZyBsZWZ0XHJcbiAgICAgICAgICAgIC8vIHNob3VsZG4ndCBsZXQgeW91IGNvbGxpZGUgd2l0aCB5b3VyIG93biBib2R5KVxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlLndoaWNoLCB0aGlzLnBhdXNlKVxyXG4gICAgICAgICAgICBjb25zdCBzbmFrZURpcmVjdGlvbiA9IHRoaXMuc25ha2UuZ2V0RGlyZWN0aW9uKCk7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5wYXVzZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUud2hpY2ggPT09IDM3ICYmIHNuYWtlRGlyZWN0aW9uLnZlY3RvclggPT09IDApIHsgLy8gbGVmdCBhcnJvdyBrZXlcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNuYWtlLmNoYW5nZURpcmVjdGlvbih7IHZlY3Rvclg6IC1HYW1lLmdyaWQsIHZlY3Rvclk6IDAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGFzdEtleSA9IDM3O1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLndoaWNoID09PSAzOCAmJiBzbmFrZURpcmVjdGlvbi52ZWN0b3JZID09PSAwKSB7IC8vIHVwIGFycm93IGtleVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc25ha2UuY2hhbmdlRGlyZWN0aW9uKHsgdmVjdG9yWDogMCwgdmVjdG9yWTogLUdhbWUuZ3JpZCB9KTtcclxuICAgICAgICAgICAgICAgICAgICBsYXN0S2V5ID0gMzg7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGUud2hpY2ggPT09IDM5ICYmIHNuYWtlRGlyZWN0aW9uLnZlY3RvclggPT09IDApIHsgLy8gcmlnaHQgYXJyb3cga2V5XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zbmFrZS5jaGFuZ2VEaXJlY3Rpb24oeyB2ZWN0b3JYOiBHYW1lLmdyaWQsIHZlY3Rvclk6IDAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGFzdEtleSA9IDM5O1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLndoaWNoID09PSA0MCAmJiBzbmFrZURpcmVjdGlvbi52ZWN0b3JZID09PSAwKSB7IC8vIGRvd24gYXJyb3cga2V5XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zbmFrZS5jaGFuZ2VEaXJlY3Rpb24oeyB2ZWN0b3JYOiAwLCB2ZWN0b3JZOiBHYW1lLmdyaWQgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGFzdEtleSA9IDQwO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZS53aGljaCA9PT0gODAgfHwgZS53aGljaCA9PT0gMTMpKXsgLy9QYXVzZVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdlbnRyYSBwYXVzZScpXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zbmFrZS5jaGFuZ2VEaXJlY3Rpb24oeyB2ZWN0b3JYOiAwLCB2ZWN0b3JZOiAwIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGF1c2UgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKChlLndoaWNoID09PSA4MCB8fCBlLndoaWNoID09PSAxMykpIHsgXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2VudHJhIGVuIE5PIHBhdXNlJylcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhdXNlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGFydCgpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEtleSA9PT0gMzcgJiYgc25ha2VEaXJlY3Rpb24udmVjdG9yWCA9PT0gMCkgeyAvLyBsZWZ0IGFycm93IGtleVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNuYWtlLmNoYW5nZURpcmVjdGlvbih7IHZlY3Rvclg6IC1HYW1lLmdyaWQsIHZlY3Rvclk6IDAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChsYXN0S2V5ID09PSAzOCAmJiBzbmFrZURpcmVjdGlvbi52ZWN0b3JZID09PSAwKSB7IC8vIHVwIGFycm93IGtleVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNuYWtlLmNoYW5nZURpcmVjdGlvbih7IHZlY3Rvclg6IDAsIHZlY3Rvclk6IC1HYW1lLmdyaWQgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChsYXN0S2V5ID09PSAzOSAmJiBzbmFrZURpcmVjdGlvbi52ZWN0b3JYID09PSAwKSB7IC8vIHJpZ2h0IGFycm93IGtleVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNuYWtlLmNoYW5nZURpcmVjdGlvbih7IHZlY3Rvclg6IEdhbWUuZ3JpZCwgdmVjdG9yWTogMCB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGxhc3RLZXkgPT09IDQwICYmIHNuYWtlRGlyZWN0aW9uLnZlY3RvclkgPT09IDApIHsgLy8gZG93biBhcnJvdyBrZXlcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zbmFrZS5jaGFuZ2VEaXJlY3Rpb24oeyB2ZWN0b3JYOiAwLCB2ZWN0b3JZOiBHYW1lLmdyaWQgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpc1NuYWtlQ29sbGlzaW9uKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IHNuYWtlQ2VsbHM6IFBvaW50W10gPSB0aGlzLnNuYWtlLmdldENlbGxzKCk7XHJcbiAgICAgICAgcmV0dXJuIHNuYWtlQ2VsbHMuc29tZSgoYzogUG9pbnQsIGk6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gaSA+IDAgJiYgYy5wb3NpdGlvblggPT09IHNuYWtlQ2VsbHNbMF0ucG9zaXRpb25YICYmIGMucG9zaXRpb25ZID09PSBzbmFrZUNlbGxzWzBdLnBvc2l0aW9uWTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBzdGFydCgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuZ2FtZU92ZXIgfHwgIXRoaXMucGF1c2UpIHtcclxuICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuc3RhcnQuYmluZCh0aGlzKSk7IFxyXG4gICAgICAgICAgICBpZiAoKyt0aGlzLmZyYW1lQ291bnQgPCAxMCkgcmV0dXJuO1xyXG4gICAgICAgICAgICB0aGlzLmZyYW1lQ291bnQgPSAwO1xyXG4gICAgICAgICAgICB0aGlzLnNuYWtlLm1vdmUodGhpcy5ib2FyZC5nZXRIZWlnaHQoKSwgdGhpcy5ib2FyZC5nZXRXaWR0aCgpLCBHYW1lLmdyaWQpO1xyXG4gICAgICAgICAgICB0aGlzLmJvYXJkLmRyYXcodGhpcy5zbmFrZSwgR2FtZS5ncmlkKTtcclxuICAgICAgICAgICAgdGhpcy5nYW1lT3ZlciA9IHRoaXMuaXNTbmFrZUNvbGxpc2lvbigpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5wYXVzZSkge1xyXG4gICAgICAgICAgICB0aGlzLmJvYXJkLnBhdXNlKCk7ICAgICAgICAgICAgXHJcbiAgICAgICAgfSBlbHNle1xyXG4gICAgICAgICAgICB0aGlzLmJvYXJkLmdhbWVPdmVyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgfVxyXG5cclxufSJdfQ==